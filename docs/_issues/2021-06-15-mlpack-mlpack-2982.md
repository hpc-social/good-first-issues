---
tags: c-binding,c-core,s-keep-open,t-added-feature,update-dependencies
title: "Replace Cython-based Arma -- Numpy conversions with Pybind11 + CARMA "
html_url: "https://github.com/mlpack/mlpack/issues/2982"
user: RUrlus
repo: mlpack/mlpack
---

### What is the desired addition or change?

Current conversion from and to Numpy arrays is done with Cython which requires a copy both in and out on Windows.
Armadillo [introduced foreign/alien allocators](https://gitlab.com/conradsnicta/armadillo-code/-/commit/544d3a36cd3c51a7e2321b7057a8ddd90cc5ca57) in version 10.5.2 that enable usage, for example, Numpy's (de)allocator allowing better interoperability with [CARMA](https://github.com/RUrlus/carma). Using Numpy's allocator/deallocator prevents the need to copy in and out on Windows.

[CARMA](https://github.com/RUrlus/carma) is a header-only library that extends [Pybind11](https://github.com/pybind/pybind11) with bilateral conversions between Numpy and Armadillo.

@rcurtin mentioned that this could be a good approach for MLPack's Python bindings.
Before I start working on a PR I wanted to discuss compatibility and the potential impact of a change.

If you believe the benefits are worth the stricter requirements I would be happy to start working on Pybind11 + CARMA based conversions.

## Changes

#### Change to minimum required versions dependencies:
- **Armadillo >= 10.5.2**
- Numpy >= 1.14 -- (CARMA)
- CMake >= 3.16 (CARMA)

The armadillo version is a significant version increase compared to the current >= 8.400.4.
I don't think the CMake version is a big deal as it can easily be installed with pip which you'll have anyway when building the bindings. Numpy 1.14 is already a few years old so that shouldn't be too much of an issue as well.

#### C-order vs F-order

I noticed that the current conversion enforces C-order whereas CARMA, optionally, enforces F-order as Armadillo is column-major. I am not sure why the C-order was chosen, but if it is required, it isn't too much work to make CARMA configurable to return C-order Numpy arrays. By default CARMA copies to F-order on the conversion from Numpy to Armadillo if needed but that can be turned off at compile time.

#### Stricter condition checks on Numpy arrays

By default CARMA will copy/convert incoming arrays if one of the below is true:

1. memory is not aligned
2. memory is not writeable
3. Numpy does not own the data
4. array has `ndim >= 2` and memory is not F-contiguous

Options 3 and 4 can be, independently, turned off at compile-time. Current implementation of the bindings doesn't seem to check writeable, CARMA provides a view on the array which doesn't consider the writeable flag.

## Benefits

[Pybind11](https://github.com/pybind/pybind11) is a popular C++ 11 library for which bindings can be automatically generated using [Binder from RosettaCommons](https://github.com/RosettaCommons/binder). This means that the bindings are all C++ so easier to use with templated code.

Consistent behaviour across platforms, current approach requires a copy in and out on Windows.

Pybind11 and CARMA support all numerical types supported by Armadillo and Numpy rather than only `int` and `double`