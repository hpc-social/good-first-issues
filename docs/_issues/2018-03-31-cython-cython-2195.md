---
tags: ,Code-Generation,Optimization,enhancement,help-wanted,performance
title: "Speed up f-string float formatting"
html_url: "https://github.com/cython/cython/issues/2195"
user: scoder
repo: cython/cython
---

There is [dedicated code](https://github.com/cython/cython/blob/e00f9c271592c3d1326f968acd0710a556033bfb/Cython/Utility/TypeConversion.c#L653) for formatting integer literals in f-strings, which avoids converting C integers to Python integer objects just for formatting them as strings. It is used by the `FormattedValueNode` in `ExprNodes.py`.

The same should be done for C float/double values, as Py2.7+ (and Py3) provides [PyOS_double_to_string()](https://docs.python.org/3/c-api/conversion.html#c.PyOS_double_to_string). See CPython's own float formatting in [unicodeobject.c](https://github.com/python/cpython/blob/master/Objects/unicodeobject.c) and [formatter_unicode.c](https://github.com/python/cpython/blob/master/Python/formatter_unicode.c).

- implement relevant tests in `tests/run/fstring.pyx` and/or check if `tests/run/test_fstring.pyx` (copied from CPython's test suite) covers this sufficiently
- extract the relevant parts of CPython's formatting implementation (potentially limiting it to easy to support formats)
- create a new C utility function in `TypeConversion.c` that formats double values
- implement `CFloatType.can_coerce_to_pystring()` in `PyrexTypes.py` to make it return `True` when supported
- implement `CFloatType.convert_to_pystring()` to call the formatting C function.