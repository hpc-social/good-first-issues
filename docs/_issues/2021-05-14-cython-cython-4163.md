---
tags: ,Testing,defect,help-wanted
title: "Untested code in Nodes.py"
html_url: "https://github.com/cython/cython/issues/4163"
user: scoder
repo: cython/cython
---

Lots of error cases are untested, which is worth improving but not urgently so.
Here are some chunks of code that _should_ better be tested (line numbers as found in [rev 0448bfbb9a1845a3cca5d07a32fdd4590f538713](https://github.com/cython/cython/blob/0448bfbb9a1845a3cca5d07a32fdd4590f538713/Cython/Compiler/Nodes.py), [HTML coverage report](https://github.com/cython/cython/suites/2745137547/artifacts/60678819)):

- [x] Nodes.py:3480
```python
3480        for arg in self.args: 
3481            if arg.hdr_type and arg.type.is_cpp_class:   # 3481 ↛ 3484
3482                # it's safe to move converted C++ types because they aren't 
3483                # used again afterwards 
3484                code.globalstate.use_utility_code( 
3485                    UtilityCode.load_cached("MoveIfSupported", "CppSupport.cpp")) 
3486                args.append("__PYX_STD_MOVE_IF_SUPPORTED(%s)" % arg.entry.cname) 
```
- [x] Nodes.py:3772
```python
3772            allow_null = all(ref.node.allow_null for ref in self.starstar_arg.entry.cf_references)  # 3772 ↛ exit
3773            if allow_null:    # 3773 ↛ 3774
3774                code.putln("%s = NULL;" % (self.starstar_arg.entry.cname,)) 
```
- [x] Nodes.py:4324
```python
4324        if old_type.is_pyobject: 
4325            if arg.default:  # 4325 ↛ 4326
4326                code.putln("if (%s) {" % arg.hdr_cname) 
4327            else: 
4328                code.putln("assert(%s); {" % arg.hdr_cname) 
4329            self.generate_arg_conversion_from_pyobject(arg, code) 
4330            code.putln("}") 
4331        elif new_type.is_pyobject:  # 4331 ↛ 4334
4332            self.generate_arg_conversion_to_pyobject(arg, code) 
4333        else: 
4334            if new_type.assignable_from(old_type): 
4335                code.putln("%s = %s;" % (arg.entry.cname, arg.hdr_cname)) 
4336            else: 
4337                error(arg.pos, "Cannot convert 1 argument from '%s' to '%s'" % (old_type, new_type)) 
```
- [ ] Nodes.py:4644
```python
4644    def analyse_expressions(self, env): 
4645        self.args = env.arg_entries 
4646        if self.py_func.is_module_scope:  # 4646 ↛ 4647
4647            first_arg = 0 
```
- [ ] Nodes.py:5042
```python
5042    def declare(self, env): 
5043        if self.module_name and self.visibility != 'extern':  # 5043 ↛ 5044
5044            module_path = self.module_name.split(".") 
5045            home_scope = env.find_imported_module(module_path, self.pos) 
5046            if not home_scope: 
5047                return None 
```
- [ ] Nodes.py:5680
```python
5680                    if func_name == 'declare': 
5681                        if isinstance(lhs, ExprNodes.NameNode):  # 5681 ↛ 5683
5682                            vars = [(lhs.name, lhs.pos)] 
5683                        elif isinstance(lhs, ExprNodes.TupleNode): 
5684                            vars = [(var.name, var.pos) for var in lhs.args] 
5685                        else: 
5686                            error(lhs.pos, "Invalid declaration") 
5687                            return 
```
- [ ] Nodes.py:5805
```python
5805                if stop_node:  # 5805 ↛ 5808
5806                    stop_node = stop_node.coerce_to(PyrexTypes.c_py_ssize_t_type, env) 
5807                else: 
5808                    if node.type.is_array and node.type.size: 
5809                        stop_node = ExprNodes.IntNode( 
5810                            self.pos, value=str(node.type.size), 
5811                            constant_result=(node.type.size if isinstance(node.type.size, _py_int_types) 
5812                                             else ExprNodes.constant_value_not_set)) 
```
- [ ] Nodes.py:5853
```python
5853        if start_node and not start_node.is_literal:  # 5853 ↛ 5854
5854            start_node = UtilNodes.LetRefNode(start_node) 
5855            refs.append(start_node) 
5856        if stop_node and not stop_node.is_literal:  # 5856 ↛ 5857
5857            stop_node = UtilNodes.LetRefNode(stop_node) 
5858            refs.append(stop_node) 
5859        if step_node and not step_node.is_literal:  # 5859 ↛ 5860
5860            step_node = UtilNodes.LetRefNode(step_node) 
5861            refs.append(step_node) 
5862 
5863        for ix in range(target_size): 
5864            ix_node = ExprNodes.IntNode(self.pos, value=str(ix), constant_result=ix, type=PyrexTypes.c_py_ssize_t_type) 
5865            if step_node is not None:  # 5865 ↛ 5866
5866                if step_node.has_constant_result(): 
5867                    step_value = ix_node.constant_result * step_node.constant_result 
5868                    ix_node = ExprNodes.IntNode(self.pos, value=str(step_value), constant_result=step_value) 
5869                else: 
5870                    ix_node = ExprNodes.MulNode(self.pos, operator='*', operand1=step_node, operand2=ix_node) 
5871            if start_node is not None: 
5872                if start_node.has_constant_result() and ix_node.has_constant_result():  # 5872 ↛ 5876
5873                    index_value = ix_node.constant_result + start_node.constant_result 
5874                    ix_node = ExprNodes.IntNode(self.pos, value=str(index_value), constant_result=index_value) 
5875                else: 
5876                    ix_node = ExprNodes.AddNode( 
```
- [ ] Nodes.py:5978
```python
5978            # Avoid coercion for overloaded assignment operators. 
5979            if next(iter(lhs_types)).is_cpp_class:  # 5979 ↛ 5980
5980                op = env.lookup_operator('=', [lhs, self.rhs]) 
5981                if not op: 
5982                    rhs = rhs.coerce_to(lhs_types.pop(), env) 
```
- [ ] Nodes.py:6482
```python
6482        if self.in_parallel:  # 6482 ↛ 6483
6483            code.putln_openmp("#pragma omp critical(__pyx_returning)") 
```
- [ ] Nodes.py:7367
```python
7367                if self.target.entry.scope.is_module_scope:  # 7367 ↛ 7372
7368                    code.globalstate.use_utility_code( 
7369                        UtilityCode.load_cached("GetModuleGlobalName", "ObjectHandling.c")) 
7370                    lookup_func = '__Pyx_GetModuleGlobalName(%s, %s); %s' 
7371                else: 
7372                    code.globalstate.use_utility_code( 
7373                        UtilityCode.load_cached("GetNameInClass", "ObjectHandling.c")) 
7374                    lookup_func = '__Pyx_GetNameInClass(%s, {}, %s); %s'.format( 
7375                        self.target.entry.scope.namespace_cname) 
```
- [ ] Nodes.py:7823
```python
7823                code.globalstate.use_utility_code( 
7824                    UtilityCode.load_cached("FastTypeChecks", "ModuleSetupCode.c")) 
7825                if len(patterns) == 2:  # 7825 ↛ 7826
7826                    exc_tests.append("__Pyx_PyErr_GivenExceptionMatches2(%s, %s, %s)" % ( 
7827                        exc_type, patterns[0], patterns[1], 
7828                    )) 
```
- [x] Nodes.py:8468
```python
8468        for pos, name, as_name, kind in self.imported_names: 
8469            if name == "*": 
8470                for local_name, entry in list(module_scope.entries.items()): 
8471                    env.add_imported_entry(local_name, entry, pos) 
8472            else: 
8473                entry = module_scope.lookup(name) 
8474                if entry: 
8475                    if kind and not self.declaration_matches(entry, kind):  # 8475 ↛ 8476
8476                        entry.redeclared(pos) 
8477                    entry.used = 1 
8478                else: 
8479                    if kind == 'struct' or kind == 'union':  # 8479 ↛ 8480
8480                        entry = module_scope.declare_struct_or_union( 
8481                            name, kind=kind, scope=None, typedef_flag=0, pos=pos) 
8482                    elif kind == 'class':  # 8482 ↛ 8483
8483                        entry = module_scope.declare_c_class(name, pos=pos, module_name=module_name) 
8484                    else: 
8485                        submodule_scope = env.context.find_module( 
8486                            name, relative_to=module_scope, pos=self.pos, absolute_fallback=False) 
8487                        if submodule_scope.parent_module is module_scope:  # 8487 ↛ 8490
8488                            env.declare_module(as_name or name, submodule_scope, self.pos) 
8489                        else: 
8490                            error(pos, "Name '%s' not declared in module '%s'" % (name, module_name)) 
```
- [ ] Nodes.py:8554
```python
8554        for name, target in self.items: 
8555            if name == '*': 
8556                for _, entry in env.entries.items(): 
8557                    if not entry.is_type and entry.type.is_extension_type:  # 8557 ↛ 8558
8558                        env.use_utility_code(UtilityCode.load_cached("ExtTypeTest", "ObjectHandling.c")) 
8559                        break 
8560            else: 
8561                entry = env.lookup(target.name) 
8562                # check whether or not entry is already cimported 
8563                if (entry.is_type and entry.type.name == name  # 8563 ↛ 8565
8564                        and hasattr(entry.type, 'module_name')): 
8565                    if entry.type.module_name == self.module.module_name.value: 
8566                        # cimported with absolute name 
8567                        continue 
8568                    try: 
8569                        # cimported with relative name 
8570                        module = env.find_module(self.module.module_name.value, pos=self.pos, 
8571                                                 relative_level=self.module.level) 
8572                        if entry.type.module_name == module.qualified_name: 
8573                            continue 
8574                    except AttributeError: 
8575                        pass 
```
- [ ] Nodes.py:9295
```python
9295            code.putln("switch (%s) {" % Naming.parallel_why) 
9296            if continue_:  # 9296 ↛ 9297
9297                code.put("    case 1: ") 
9298                code.put_goto(code.continue_label) 
9299 
9300            if break_:  # 9300 ↛ 9301
9301                code.put("    case 2: ") 
9302                code.put_goto(code.break_label) 
```